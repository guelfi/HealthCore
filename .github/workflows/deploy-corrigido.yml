name: Deploy para ProduÃ§Ã£o - Corrigido

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy no servidor
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # Configurar modo rigoroso de erro
          set -euo pipefail
          
          echo "ðŸš€ Iniciando deploy do MobileMed..."
          
          # Navegar para o diretÃ³rio do projeto
          cd /var/www/DesafioTecnico
          
          # FunÃ§Ã£o para limpeza completa de containers
          cleanup_containers() {
            echo "ðŸ§¹ Limpando containers existentes..."
            
            # Parar serviÃ§os do Docker Compose
            docker compose down --remove-orphans --volumes 2>/dev/null || true
            
            # Remover containers especÃ­ficos se ainda existirem
            docker rm -f mobilemed-api mobilemed-frontend 2>/dev/null || true
            
            # Remover containers Ã³rfÃ£os
            docker container prune -f 2>/dev/null || true
            
            # Remover redes nÃ£o utilizadas
            docker network prune -f 2>/dev/null || true
            
            # Remover imagens dangling
            docker image prune -f 2>/dev/null || true
            
            # Aguardar liberaÃ§Ã£o dos recursos
            sleep 3
            
            echo "âœ… Limpeza concluÃ­da"
          }
          
          # FunÃ§Ã£o para verificar Docker
          check_docker() {
            echo "ðŸ” Verificando Docker..."
            if ! docker --version >/dev/null 2>&1; then
              echo "âŒ Docker nÃ£o funciona. Reinstalando..."
              
              # Remover Docker antigo
              sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
              
              # Instalar Docker
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo systemctl start docker
              sudo systemctl enable docker
              
              # Adicionar usuÃ¡rio ao grupo docker se nÃ£o estiver
              sudo usermod -aG docker $USER || true
              
              rm get-docker.sh
            fi
            echo "âœ… Docker funcionando"
          }
          
          # Executar verificaÃ§Ãµes
          check_docker
          cleanup_containers
          
          # Atualizar cÃ³digo
          echo "ðŸ“¥ Atualizando cÃ³digo..."
          git fetch origin
          git reset --hard origin/main 2>/dev/null || git reset --hard origin/master
          
          # Build e deploy
          echo "ðŸ”¨ Fazendo build dos containers..."
          
          # Build sem cache para garantir atualizaÃ§Ã£o
          docker compose build --no-cache --parallel
          
          # Verificar se as imagens foram criadas
          if ! docker images | grep -E "(desafiotecnico[_-]mobilemed|mobilemed)" | head -2; then
            echo "âŒ Falha no build das imagens"
            exit 1
          fi
          
          # Iniciar serviÃ§os
          echo "ðŸš€ Iniciando serviÃ§os..."
          docker compose up -d --remove-orphans
          
          # Aguardar inicializaÃ§Ã£o
          echo "â³ Aguardando inicializaÃ§Ã£o dos serviÃ§os..."
          sleep 15
          
          # Verificar se os containers estÃ£o rodando
          if ! docker compose ps --services --filter "status=running" | grep -q .; then
            echo "âŒ Containers nÃ£o iniciaram corretamente"
            echo "ðŸ“‹ Status atual:"
            docker compose ps
            echo "ðŸ“‹ Logs dos serviÃ§os:"
            docker compose logs --tail=20
            exit 1
          fi
          
          # Health checks detalhados
          echo "ðŸ¥ Verificando saÃºde dos serviÃ§os..."
          
          # Verificar API com retry
          api_healthy=false
          for i in {1..12}; do
            if curl -f -s --max-time 5 http://localhost:5000/health >/dev/null 2>&1; then
              echo "âœ… API estÃ¡ saudÃ¡vel"
              api_healthy=true
              break
            fi
            if [ $i -eq 12 ]; then
              echo "âŒ API nÃ£o responde apÃ³s 12 tentativas"
              echo "ðŸ“‹ Logs da API:"
              docker compose logs --tail=10 mobilemed-api
              exit 1
            fi
            echo "â³ Aguardando API... (tentativa $i/12)"
            sleep 5
          done
          
          # Verificar Frontend
          frontend_healthy=false
          for i in {1..8}; do
            if curl -f -s --max-time 3 http://localhost:5005 >/dev/null 2>&1; then
              echo "âœ… Frontend estÃ¡ acessÃ­vel"
              frontend_healthy=true
              break
            fi
            if [ $i -eq 8 ]; then
              echo "âŒ Frontend nÃ£o responde apÃ³s 8 tentativas"
              echo "ðŸ“‹ Logs do Frontend:"
              docker compose logs --tail=10 mobilemed-frontend
              exit 1
            fi
            echo "â³ Aguardando Frontend... (tentativa $i/8)"
            sleep 3
          done
          
          # VerificaÃ§Ã£o de integridade adicional
          echo "ðŸ” VerificaÃ§Ã£o de integridade..."
          
          # Verificar se os containers estÃ£o saudÃ¡veis
          for service in mobilemed-api mobilemed-frontend; do
            health_status=$(docker inspect --format='{{.State.Health.Status}}' $service 2>/dev/null || echo "no-healthcheck")
            if [ "$health_status" = "healthy" ] || [ "$health_status" = "no-healthcheck" ]; then
              echo "âœ… $service: $health_status"
            else
              echo "âš ï¸ $service: $health_status"
            fi
          done
          
          # Deploy bem-sucedido
          echo ""
          echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
          echo "ðŸ“Š Status final dos serviÃ§os:"
          docker compose ps
          
          echo ""
          echo "ðŸŒ URLs de acesso:"
          PUBLIC_IP=$(curl -s --max-time 3 ifconfig.me 2>/dev/null || echo "SEU_IP_PUBLICO")
          echo "   Frontend: http://$PUBLIC_IP:5005"
          echo "   API: http://$PUBLIC_IP:5000"
          echo "   Health API: http://$PUBLIC_IP:5000/health"
          
          echo ""
          echo "ðŸ“ˆ Recursos utilizados:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
