name: Deploy to Production - Fixed

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # Configurar modo de erro rigoroso
          set -e
          
          echo "ğŸš€ Iniciando deploy do MobileMed..."
          
          # Navegar para o diretÃ³rio do projeto
          cd /var/www/DesafioTecnico
          
          # Atualizar cÃ³digo
          echo "ğŸ“¥ Atualizando cÃ³digo..."
          git pull origin main
          
          # FunÃ§Ã£o para limpeza completa de containers
          cleanup_containers() {
            echo "ğŸ§¹ Limpando containers existentes..."
            
            # Parar e remover containers especÃ­ficos
            docker stop mobilemed-api mobilemed-frontend 2>/dev/null || true
            docker rm mobilemed-api mobilemed-frontend 2>/dev/null || true
            
            # Remover containers Ã³rfÃ£os com force
            docker container prune -f 2>/dev/null || true
            
            # Remover redes nÃ£o utilizadas
            docker network prune -f 2>/dev/null || true
            
            # Aguardar liberaÃ§Ã£o dos recursos
            sleep 5
            
            echo "âœ… Limpeza de containers concluÃ­da"
          }
          
          # FunÃ§Ã£o para verificar se Docker estÃ¡ funcionando
          check_docker() {
            echo "ğŸ” Verificando Docker..."
            if ! docker --version >/dev/null 2>&1; then
              echo "âŒ Docker nÃ£o estÃ¡ funcionando. Reinstalando..."
              
              # Remover Docker antigo
              sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
              
              # Instalar Docker
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo systemctl start docker
              sudo systemctl enable docker
              
              rm get-docker.sh
            fi
            echo "âœ… Docker funcionando"
          }
          
          # Executar verificaÃ§Ãµes e limpeza
          check_docker
          cleanup_containers
          
          # Build e deploy com tratamento de erro
          echo "ğŸ”¨ Fazendo build e iniciando containers..."
          
          # Remover docker-compose.yml version obsoleta
          if grep -q "^version:" docker-compose.yml; then
            sed -i '/^version:/d' docker-compose.yml
            echo "âœ… Removido 'version' obsoleto do docker-compose.yml"
          fi
          
          # Build com cleanup forÃ§ado
          docker-compose down --volumes --remove-orphans 2>/dev/null || true
          docker-compose build --no-cache
          
          # Verificar se as imagens foram criadas
          if ! docker images | grep -q "desafiotecnico-mobilemed-api\|desafiotecnico-mobilemed-frontend"; then
            echo "âŒ Falha no build das imagens"
            exit 1
          fi
          
          # Iniciar serviÃ§os
          docker-compose up -d
          
          # Aguardar inicializaÃ§Ã£o
          echo "â³ Aguardando inicializaÃ§Ã£o dos serviÃ§os..."
          sleep 30
          
          # Verificar se os containers estÃ£o rodando
          if ! docker-compose ps | grep -q "Up"; then
            echo "âŒ Containers nÃ£o iniciaram corretamente"
            docker-compose logs
            exit 1
          fi
          
          # Health check
          echo "ğŸ¥ Verificando saÃºde dos serviÃ§os..."
          
          # Verificar API
          for i in {1..10}; do
            if curl -f -s http://localhost:5000/health >/dev/null; then
              echo "âœ… API estÃ¡ respondendo"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ API nÃ£o estÃ¡ respondendo apÃ³s 10 tentativas"
              docker-compose logs mobilemed-api
              exit 1
            fi
            echo "â³ Aguardando API... (tentativa $i/10)"
            sleep 10
          done
          
          # Verificar Frontend
          for i in {1..5}; do
            if curl -f -s http://localhost:5005 >/dev/null; then
              echo "âœ… Frontend estÃ¡ respondendo"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ Frontend nÃ£o estÃ¡ respondendo apÃ³s 5 tentativas"
              docker-compose logs mobilemed-frontend
              exit 1
            fi
            echo "â³ Aguardando Frontend... (tentativa $i/5)"
            sleep 5
          done
          
          # Deploy bem-sucedido
          echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
          echo "ğŸ“Š Status dos serviÃ§os:"
          docker-compose ps
          
          echo ""
          echo "ğŸŒ URLs de acesso:"
          echo "   Frontend: http://$(curl -s ifconfig.me):5005"
          echo "   API: http://$(curl -s ifconfig.me):5000"
          echo "   Health: http://$(curl -s ifconfig.me):5000/health"
